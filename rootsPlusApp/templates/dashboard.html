{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<div class="container py-4 ">
    {% if messages %}
    {% for message in messages %}
    <div class="w-75 alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show mb-3"
        role="alert">
        <i class="bi bi-info-circle me-2"></i> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <h4 class="mb-0">
            Welcome, {% if role == 'agronomist' %}Eng. {% endif %}
            <span class="text-danger fw-bold">{{ userName }}</span>
        </h4>

        <div class="d-flex flex-wrap gap-2">

            <button id="loadWeather" class="btn btn-outline-primary btn-sm d-inline d-md-none">
                <i class="bi bi-arrow-repeat"></i> Refresh Weather
            </button>

            <button id="loadWeather" class="btn btn-outline-primary d-none d-md-inline">
                <i class="bi bi-arrow-repeat"></i> Refresh Weather
            </button>


            <a href="{% url 'rootsPlusApp:add_farm' %}" class="btn btn-success btn-sm d-inline d-md-none">
                <i class="bi bi-plus-circle me-1"></i> Add New Farm
            </a>


            <a href="{% url 'rootsPlusApp:add_farm' %}" class="btn btn-success d-none d-md-inline">
                <i class="bi bi-plus-circle me-1"></i> Add New Farm
            </a>
        </div>
    </div>


    <div id="weatherContainer" class="row g-3 justify-content-around mt-2 mb-4"></div>

    {% if role in 'farmer user' %}
    <!-- Farmer Stats -->
    {% if farms %}
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <h6>Total Farms</h6>
                    <h3 class="text-success counter" data-target="{{ farms_count }}">0</h3>
                    <small>farms</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <h6>Total Crops</h6>
                    <h3 class="text-primary counter" data-target="{{ total_crops }}">0</h3>
                    <small>crops</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <h6>Avg Yield / dunum</h6>
                    <h3 class="text-danger counter" data-target="{{ avg_yield_per_dunum }}">0</h3>
                    <small>tons</small>
                </div>
            </div>
        </div>
    </div>

    {% endif %}

    {% elif role == 'agronomist' %}
    <!-- KPI Section -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted">Total Farms</h6>
                    <h3 class="fw-bold counter" data-target="{{ total_farms }}">0</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted">Total Crops</h6>
                    <h3 class="fw-bold counter" data-target="{{ total_crops }}">0</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted">Evaluations Done</h6>
                    <h3 class="fw-bold counter" data-target="{{ total_evaluations }}">0</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted">Last Evaluation</h6>
                    <h5 class="fw-bold">
                        {% if last_eval_date %}
                        {{ last_eval_date|date:"Y-m-d" }}
                        {% else %}
                        N/A
                        {% endif %}
                    </h5>
                </div>
            </div>
        </div>
    </div>

    {% endif %}
    <div class="row subContainer d-flex justify-content-between align-items-start">
        <div class="col-12 col-md-6 leftSide">

            {% if role in 'farmer user' %}
            <!-- Farmer Farms List -->
            <h4 class="mb-3">
                Your Farms <i class="bi bi-arrow-bar-right text-secondary fw-bolder fs-5"></i> <span
                    class="badge bg-info fs-6">{{ farms_count }} farms</span>
            </h4>
            <div class="list-group mb-4">
                {% for farm in farms %}
                <div class="list-group-item p-4">
                    <h6><a href="{% url 'rootsPlusApp:farm_detail' farm.id %}"
                            class="fw-bold text-decoration-none text-dark">
                            {{ farm.name }}
                        </a> | <small class="text-muted">{{ farm.location }} {{ farm.total_area }} dunum</small></h6>
                    <div class="mt-3">
                        <h6 class="text-muted" style="font-size: 14px;">Supervising Agronomists</h6>
                        <ul>
                            {% if farm.agronomists.all %}
                            {% for agro in farm.agronomists.all %}
                            <li><span class="badge bg-success me-1">{{ agro.name }}</span></li>
                            {% endfor %}
                            {% else %}
                            <li><span class="text-muted">No agronomists assigned</span></li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="mt-4">
                        <a href="{% url 'rootsPlusApp:evaluations_list' farm.id %}"
                            class="btn btn-sm btn-outline-primary me-2">View
                            Evaluations</a>
                        <a href="{% url 'rootsPlusApp:reports_list' farm.id %}"
                            class="btn btn-sm btn-outline-secondary me-2">View Reports</a>
                    </div>
                </div>
                {% empty %}
                <div class="alert alert-info">No farms yet. Add one to get started.</div>
                {% endfor %}
            </div>
            <!-- Latest Evaluations -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-card-checklist me-2 text-warning"></i> Latest Evaluations
                    </h5>
                </div>

                {% if latest_evaluations %}
                <div class="table-responsive ">
                    <table class="table table-bordered table-hover mb-0 text-center">
                        <thead class="table-light">
                            <tr>
                                <th>Farm</th>
                                <th>Evaluator</th>
                                <th>Score</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for eval in latest_evaluations %}
                            <tr>
                                <td>{{ eval.farm.name }}</td>
                                <td>Eng. {{ eval.farm.agronomists.first.name }}</td>
                                <td>
                                    <span class="{% if eval.overall_score >= 7 %}text-success fw-bold
                                        {% elif eval.overall_score < 4 %}text-danger fw-bold
                                        {% else %}text-warning fw-bold{% endif %}">
                                        {{ eval.overall_score|default:"-" }}
                                    </span>
                                </td>
                                <td>{{ eval.created_at|date:"Y-m-d H:i" }}</td>
                                <td>
                                    <a href="{% url 'rootsPlusApp:evaluation_detail' eval.id %}"
                                        class="btn btn-sm btn-outline-danger">View</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="card-body">
                    <div class="alert alert-info mb-0">
                        No evaluations available for your farms yet.
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Latest Reports -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-card-list me-2 text-dark"></i> Latest Reports
                    </h5>
                </div>

                {% if latest_reports %}
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0 text-center">
                        <thead class="table-light">
                            <tr>
                                <th>Farm</th>
                                <th>Season</th>
                                <th>Agronomist</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in latest_reports %}
                            <tr>
                                <td>{{ report.farm.name }}</td>
                                <td>{{ report.season|default:"N/A" }}</td>
                                <td>Eng. {{ report.farm.agronomists.first.name }}</td>
                                <td>{{ report.generated_at|date:"Y-m-d H:i" }}</td>
                                <td>
                                    <a href="{% url 'rootsPlusApp:report_detail' report.farm.id report.id %}"
                                        class="btn btn-sm btn-outline-info">View</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="card-body">
                    <div class="alert alert-warning mb-0">
                        No reports generated for your farms yet.
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}



            {% if role == 'agronomist' %}
            <!-- Farms You Manage -->
            <h4 class="mb-3">Farms You Manage <i class="bi bi-arrow-bar-right text-secondary fw-bolder fs-5"></i>
                <span class="badge bg-info fs-6">{{ farms_count }} farms</span>
            </h4>
            <div class="list-group mb-4">
                {% for farm in farms %}
                <div class="list-group-item p-4">
                    <a href="{% url 'rootsPlusApp:farm_detail' farm.id %}"
                        class="fw-bold text-decoration-none text-dark">
                        {{ farm.name }}
                    </a>
                    {% if farm.user %}
                    — Owner: {{ farm.user.name }}
                    {% else %}
                    — Owner: Not assigned
                    {% endif %}
                    — {{ farm.location }}
                    <div class="mt-3 co1-8 mx-auto d-flex flex-column flex-md-row gap-2">
                        <a href="{% url 'rootsPlusApp:evaluations_list' farm.id %}"
                            class="btn btn-sm btn-outline-primary ">View
                            Evaluations</a>
                        <a href="{% url 'rootsPlusApp:reports_list' farm.id %}"
                            class="btn btn-sm btn-outline-secondary ">View
                            Reports</a>
                        <a href="{% url 'rootsPlusApp:add_evaluation' farm.id %}" class="btn btn-sm btn-success ">+
                            Add
                            Evaluation</a>
                        <a href="{% url 'rootsPlusApp:add_report' farm.id %}" class="btn btn-sm btn-warning">+ Add
                            Report</a>
                    </div>
                </div>
                {% empty %}
                <div class="alert alert-info">No farms assigned to you yet.</div>
                {% endfor %}
            </div>

            <!-- Latest Evaluations by Agronomist -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-card-checklist me-2 text-warning"></i> Latest Evaluations You Performed
                    </h5>
                </div>

                {% if latest_evaluations %}
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0 text-center align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Farm</th>
                                <th>Score</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for eval in latest_evaluations %}
                            <tr>
                                <td>{{ eval.farm.name }}</td>
                                <td>
                                    <span class="{% if eval.overall_score >= 7 %}text-success fw-bold
                                      {% elif eval.overall_score < 4 %}text-danger fw-bold
                                      {% else %}text-warning fw-bold{% endif %}">
                                        {{ eval.overall_score|default:"-" }}
                                    </span>
                                </td>
                                <td>{{ eval.created_at|date:"Y-m-d H:i" }}</td>
                                <td>
                                    <a href="{% url 'rootsPlusApp:evaluation_detail' eval.id %}"
                                        class="btn btn-sm btn-outline-dark">View</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="card-body">
                    <div class="alert alert-info mb-0">
                        You haven't performed any evaluations yet.
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Latest Reports by Agronomist -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-card-list me-2 text-dark"></i> Latest Reports You Created
                    </h5>
                </div>

                {% if latest_reports %}
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0 text-center align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Farm</th>
                                <th>Season</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in latest_reports %}
                            <tr>
                                <td>{{ report.farm.name }}</td>
                                <td>{{ report.season|default:"N/A" }}</td>
                                <td>{{ report.generated_at|date:"Y-m-d H:i" }}</td>
                                <td>
                                    <a href="{% url 'rootsPlusApp:report_detail' report.farm.id report.id %}"
                                        class="btn btn-sm btn-outline-secondary">View</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="card-body">
                    <div class="alert alert-warning mb-0">
                        You haven't created any reports yet.
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

        </div>
        <div class="col-12 col-md-5 rightSide">
            {% if role in 'farmer user' %}
            <div>
                <h5 class="mt-4"><i class="bi bi-bar-chart text-danger fw-bold fs-4"></i> Farms Overview</h5>
                <canvas id="farmUserChart" height="200" class="mt-5"></canvas>
                <hr>
                <canvas id="farmPolarChart" class="mt-5"></canvas>
                <hr>
            </div>


            {% endif %}
            {% if role == 'agronomist' %}
            <div>
                <h5 class="mt-4"><i class="bi bi-bar-chart text-danger fw-bold fs-4"></i> Farms Overview</h5>
                <canvas id="farmChart" height="200" class="mt-4"></canvas>
                <hr>
                <canvas id="agronomistBubbleChart"></canvas>
                <hr>
                <div class="card mt-4 shadow-sm">
                    <div class="card-header bg-secondary text-white text-center fw-bold">
                        Agronomist Farm Overview
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-striped table-hover table-bordered mb-0 text-center align-middle ">
                            <thead class="table-light">
                                <tr class="align-middle">
                                    <th scope="col">Farm</th>
                                    <th scope="col">Crops Count</th>
                                    <th scope="col">Average Yield (tons/dunum)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for farm in farms %}
                                <tr>
                                    <td class="fw-semibold text-capitalize">{{ farm.name }}</td>
                                    <td>{{ farm.get_crops_count }}</td>
                                    <td>{{ farm.get_average_yield_per_dunum }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <hr>
                {% endif %}
            </div>

        </div>

    </div>
</div>


{% endblock %}

{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-trendline/dist/chartjs-plugin-trendline.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('farmUserChart').getContext('2d');

        // البيانات من الـ view (JSON آمن)
        const farmLabels = JSON.parse('{{ farm_names|escapejs }}');
        const cropsCounts = JSON.parse('{{ crops_counts|escapejs }}');
        const totalYields = JSON.parse('{{ total_yields|escapejs }}');
        const maxCrops = Math.max(...cropsCounts);



        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: farmLabels,
                datasets: [
                    {
                        label: 'Crops Count',
                        data: cropsCounts,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        yAxisID: 'yCrops',
                        trendlineLinear: {
                            colorMin: "rgba(0,0,255,0.5)",
                            colorMax: "rgba(0,0,255,0.5)",
                            lineStyle: "dashed",
                            width: 2
                        }
                    },
                    {
                        label: 'Total Yield (tons)',
                        data: totalYields,
                        backgroundColor: 'rgba(255, 159, 64, 0.7)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1,
                        yAxisID: 'yYield'   // المحور الثاني (يمين)
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: true, text: 'Farms: Crops & Yield' }
                },
                scales: {
                    yCrops: {
                        type: 'linear',
                        position: 'left',
                        beginAtZero: true,
                        max: maxCrops + 5,
                        ticks: {
                            stepSize: 1   // يخلي التدريج مناسب للقيم الصغيرة
                        },
                        title: {
                            display: true,
                            text: 'Crops Count'
                        }
                    },
                    yYield: {
                        type: 'linear',
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Total Yield (tons)'
                        },
                        grid: {
                            drawOnChartArea: false // يمنع تداخل الشبكة مع المحور الآخر
                        }
                    }
                }
            }
        });

    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('farmPolarChart').getContext('2d');

        const farmLabels = JSON.parse('{{ farm_names|escapejs }}');
        const totalYields = JSON.parse('{{ total_yields|escapejs }}');

        new Chart(ctx, {
            type: 'polarArea',
            data: {
                labels: farmLabels,
                datasets: [{
                    label: 'Total Yield (tons)',
                    data: totalYields,
                    backgroundColor: [
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(231, 76, 60, 0.7)',
                        'rgba(155, 89, 182, 0.7)'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 13 },
                            color: '#333'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Farm Total Yield (Polar Area)',
                        font: { size: 16, weight: 'bold' }
                    }
                },
                scales: {
                    r: {
                        min: 0,          // أقل قيمة
                        max: 1500,       // أكبر قيمة (كل ما كبرتها، صغرت الدائرة)
                        ticks: {
                            stepSize: 250,
                            backdropColor: 'transparent'
                        },
                        grid: {
                            color: '#eee'
                        }
                    }
                }
            }
        });
    });
</script>

<!-- Agro Chart -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('farmChart').getContext('2d');

        // البيانات من الـ view (JSON آمن)
        const farmLabels = JSON.parse('{{ farm_names|escapejs }}');
        const cropsCounts = JSON.parse('{{ crops_counts|escapejs }}');
        const avgYields = JSON.parse('{{ avg_yields|escapejs }}');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: farmLabels,
                datasets: [
                    {
                        label: 'Crops Count',
                        data: cropsCounts,
                        backgroundColor: 'rgba(65, 202, 179, 0.6)',
                        borderColor: 'rgba(65, 202, 179, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Avg Yield per Dunum (tons)',
                        data: avgYields,
                        backgroundColor: 'rgba(25, 24, 59, 0.6)',
                        borderColor: 'rgba(25, 24, 59, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: true, text: 'Farms Managed by You' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    });
</script>

<script>
    const bubbleData = JSON.parse('{{ bubble_data|escapejs }}');
    const colorPalette = [
        'rgba(52, 152, 219, 0.7)',
        'rgba(46, 204, 113, 0.7)',
        'rgba(241, 196, 15, 0.7)',
        'rgba(231, 76, 60, 0.7)',
        'rgba(155, 89, 182, 0.7)'
    ];
    const datasets = bubbleData.map((farm, index) => ({
        label: farm.label,
        data: [{ x: farm.x, y: farm.y, r: farm.r }],
        backgroundColor: colorPalette[index % colorPalette.length],
        borderColor: '#fff',
        borderWidth: 2
    }));


    new Chart(document.getElementById('agronomistBubbleChart'), {
        type: 'bubble',
        data: { datasets },
        options: {
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: { size: 13, weight: 'bold' },
                        color: '#333'
                    }
                },
                title: {
                    display: true,
                    text: 'Agronomist Activities, Evaluations, and Reports per Farm',
                    font: { size: 16, weight: 'bold' },
                    color: '#2c3e50'
                },
                tooltip: {
                    backgroundColor: '#f9f9f9',
                    titleColor: '#000',
                    bodyColor: '#333',
                    borderColor: '#ccc',
                    borderWidth: 1,
                    callbacks: {
                        label: function (context) {
                            const farm = context.dataset.label;
                            const { x, y, r } = context.raw;
                            return [
                                `Farm: ${farm}`,
                                `Activities: ${x}`,
                                `Evaluations: ${y}`,
                                `Reports: ${Math.round(r / 5)}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Number of Activities' },
                    beginAtZero: true,
                    ticks: { stepSize: 1, precision: 0 }
                },
                y: {
                    title: { display: true, text: 'Number of Evaluations' },
                    beginAtZero: true,
                    ticks: { stepSize: 1, precision: 0 }
                }
            }
        }
    });
</script>
<script>

    async function loadWeather() {
        const container = document.getElementById("weatherContainer");
        if (!container) return;

        container.innerHTML = "";

        try {
            const response = await fetch("/content/farms_weather/", { cache: "no-store" });
            const data = await response.json();

            data.forEach(item => {
                const card = document.createElement("div");
                card.className = " col-6 col-sm-5 col-md-2 d-flex flex-wrap justify-content-center";
                card.innerHTML = `
                    
                  <div class="card shadow-sm border-0 rounded-3 bg-light h-100 text-start d-flex align-items-center " style="width: 200px;">
                    
                        <div class="card-body p-2 mb-1">
                            
                            <p class="fw-semibold text-primary mb-1 small">
                            <i class="bi bi-leaf me-1 text-success"></i> ${item.farm}
                            </p>

                            
                            <p class="text-dark mb-2 small">
                            <i class="bi bi-geo-alt-fill text-danger me-1"></i> ${item.location}
                            </p>

                            
                            <p class="fw-bold text-dark mb-1 small">
                            <i class="bi bi-thermometer-half text-warning me-1"></i> ${item.temp} °C
                            </p>

                            <
                            <p class="text-dark mb-2 small">
                            <i class="bi bi-cloud-sun-fill text-info me-1 fs-5"></i> ${item.desc}
                            </p>
                            <h6 class="text-dark mb-2 small">
                            <i class="bi bi-clock text-secondary me-1"></i> Time: ${item.time}
                            </h6>
                        </div>

                </div>
                `;
                container.appendChild(card);
            });
        } catch (error) {
            container.innerHTML = "<p class='text-danger'>Unable to fetch weather</p>";
        }
    }


    loadWeather();

    document.getElementById("loadWeather").addEventListener("click", function () {
        loadWeather();
    });




</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const counters = document.querySelectorAll('.counter');
        const duration = 600;

        counters.forEach(counter => {
            const target = +counter.getAttribute('data-target');
            const startTime = performance.now();

            const animate = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // دالة easing بسيطة (easeOutQuad)
                const easeOutQuad = (t) => t * (4 - t);

                const easedProgress = easeOutQuad(progress);
                const currentValue = Math.floor(easedProgress * target);

                counter.innerText = currentValue;

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    counter.innerText = target;
                }
            };

            requestAnimationFrame(animate);
        });
    });
</script>

{% endblock %}