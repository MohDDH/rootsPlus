{% extends 'base.html' %}
{% block title %}Edit Crops for {{ farm.name }}{% endblock %}

{% block content %}
<div class="container py-5">
    <h3 class="mb-4">Edit Crops for {{ farm.name }}</h3>

    <!-- Django Messages -->
    {% if messages %}
    {% for message in messages %}
    <div class="w-75 alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show mb-3"
        role="alert">
        <i class="bi bi-info-circle me-2"></i> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    <!-- End Django Messages -->

    <form method="post">
        {% csrf_token %}
        <input type="hidden" id="farmArea" value="{{ farm.total_area }}">

        <div id="cropContainer" class="d-flex flex-wrap justify-content-start align-items-start gap-3">
            {% for crop in crops %}
            <div class="crop-row border p-3 mb-3" style="width: 520px;">
                <input type="hidden" name="crop_id[]" value="{{ crop.id }}">
                <input type="text" name="crop_name[]" value="{{ crop.crop_name }}" placeholder="Crop Name"
                    class="form-control mb-2" required>
                <input type="number" name="crop_area[]" value="{{ crop.crop_area }}" placeholder="Crop Area (dunum)"
                    step="0.01" class="form-control mb-2" required>
                <div class="form-floating mb-2">
                    <input type="date" name="planting_date[]" value="{{ crop.planting_date|date:'Y-m-d' }}"
                        class="form-control" id="plantingDate{{ forloop.counter }}">
                    <label for="plantingDate{{ forloop.counter }}">Crop Planting Date</label>
                </div>
                <input type="number" name="yield_per_dunum[]" value="{{ crop.yield_per_dunum }}"
                    placeholder="Yield per dunum" step="0.01" class="form-control mb-2">
                <input type="text" name="status[]" value="{{ crop.status }}" placeholder="Status"
                    class="form-control mb-2">
                <button type="button" class="btn btn-danger btn-sm remove-row">Remove</button>
            </div>
            {% endfor %}
        </div>

        
        <div id="templateRow" class="crop-row border p-3 mb-3 d-none" style="width: 520px;">
            <input type="hidden" name="crop_id[]" value="">
            <input type="text" name="crop_name[]" placeholder="Crop Name" class="form-control mb-2" >
            <input type="number" name="crop_area[]" placeholder="Crop Area (dunum)" step="0.01"
                class="form-control mb-2" >
            <div class="form-floating mb-2">
                <input type="date" name="planting_date[]" class="form-control">
                <label>Crop Planting Date</label>
            </div>
            <input type="number" name="yield_per_dunum[]" placeholder="Yield per dunum" step="0.01"
                class="form-control mb-2">
            <input type="text" name="status[]" placeholder="Status" class="form-control mb-2">
            <button type="button" class="btn btn-danger btn-sm remove-row">Remove</button>
        </div>

        <button type="button" id="addCropBtn" class="btn btn-secondary mt-3">+ Add Another Crop</button>
        <button type="submit" class="btn btn-success mt-3">Save Changes</button>
        <a href="{% url 'rootsPlusApp:farm_detail' farm.id %}" class="btn btn-outline-secondary mt-3 ms-2">Back to
            Farm</a>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const farmArea = parseFloat(document.getElementById('farmArea').value);
        const form = document.querySelector('form');
        const addBtn = document.getElementById('addCropBtn');
        const container = document.getElementById('cropContainer');
        const template = document.getElementById('templateRow');

        // Add new crop row
        addBtn.addEventListener('click', function () {
            const newRow = template.cloneNode(true);
            newRow.classList.remove('d-none');
            newRow.querySelectorAll('input').forEach(input => {
                input.value = '';
                if (input.type !== 'hidden') {
                    input.required = true; // رجّع required فقط للصف الجديد
                }
            });
            container.appendChild(newRow);
        });

        // Remove crop row
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-row')) {
                const rows = document.querySelectorAll('.crop-row');
                if (rows.length > 1) {
                    e.target.closest('.crop-row').remove();
                }
            }
        });

        // Validate total crop area before submit
        form.addEventListener('submit', function (e) {
            let totalCropArea = 0;
            const areaInputs = document.querySelectorAll('input[name="crop_area[]"]');

            for (let i = 0; i < areaInputs.length; i++) {
                const value = parseFloat(areaInputs[i].value);
                if (!isNaN(value)) {
                    totalCropArea += value;
                }
            }

            if (totalCropArea > farmArea) {
                e.preventDefault();
                alert("Total crop area (" + totalCropArea + ") exceeds farm capacity (" + farmArea + ").");
            }
        });
    });
</script>
{% endblock %}