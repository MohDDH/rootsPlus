{% extends 'base.html' %}
{% block title %}Farm Details{% endblock %}

{% block content %}

<div id="farmWeatherContainer"></div>
{% if messages %}
{% for message in messages %}
<div class="w-100 alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show mb-3"
    role="alert">
    <i class="bi bi-info-circle me-2"></i> {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

{% endfor %}
{% endif %}
<!-- End Django Messages -->
<div class="container py-4 d-flex flex-column flex-md-row justify-content-between align-items-start mx-auto col-12">


    <!-- Django Messages -->

    <!-- Left Side -->
    <div class="leftSide col-10 mx-auto col-md-7">

        <div class="controlsLargeScreen  d-block d-md-none">
            
            {% if role in 'user farmer' %}
            <div class="mb-3 d-flex align-items-center">
                <form method="post" action="{% url 'rootsPlusApp:delete_farm' farm.id %}"
                    onsubmit="return confirm('⚠️ Are you sure you want to delete this farm? This action cannot be undone.');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger me-2">
                        <i class="bi bi-trash me-1"></i> Delete Farm
                    </button>
                </form>
                <a href="{% url 'rootsPlusApp:edit_farm_crops' farm.id %}" class="btn btn-outline-primary ">
                    <i class="bi bi-pencil-square me-1"></i> Edit Crops
                </a>
            </div>
            {% endif %}

            
            {% if role == 'agronomist' %}
            <div class="mb-3">
                {% if is_managed %}
                <!-- Unmanage Farm -->
                <form id="unmanage-farm-form" method="post" action="{% url 'rootsPlusApp:unmanage_farm' farm.id %}"
                    class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger"
                        onclick="return confirm('⚠️ Are you sure you want to unmanage this farm?');">
                        <i class="bi bi-x-circle me-1"></i> Unmanage Farm
                    </button>
                </form>
                {% else %}
                <!-- Manage Farm -->
                <form method="post" action="{% url 'rootsPlusApp:manage_farm' farm.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-1"></i> Manage Farm
                    </button>
                </form>
                {% endif %}
            </div>
            {% endif %}
            <div class="d-flex align-items-center gap-2">
                {% if role == 'agronomist' and is_managed %}
                <a href="{% url 'rootsPlusApp:add_activity' farm.id %}" class="btn btn-sm btn-success mb-3">
                    <i class="bi bi-plus-circle me-1"></i> Add New Activity
                </a>
                {% endif %}

                <a href="{% url 'rootsPlusApp:farm_activities' farm.id %}" class="btn btn-warning btn-sm mb-3">
                    <i class="bi bi-list-task me-1"></i> View All Activities
                </a>
            </div>
        </div>

        <h2 class="fw-bold mb-3">{{ farm.name }}</h2>
        <p><strong>Location:</strong> {{ farm.location }}</p>
        <p><strong>Total Area:</strong> {{ farm.total_area }} dunum</p>
        <p><strong>Owner:</strong> {{ farm.user.name }}</p>
        <p><strong>Supervising Agronomists:</strong></p>
        <ul class="list-group list-group-flush">
            {% for agro in farm.agronomists.all %}
            <li class="list-group-item">
                <i class="bi bi-person-badge me-2 text-success fw-bold"></i> {{ agro }}
            </li>
            {% empty %}
            <li class="list-group-item text-muted">
                <i class="bi bi-exclamation-circle me-2"></i> No supervising agronomists assigned.
            </li>
            {% endfor %}
        </ul>

        <hr>

        <!-- Statistics -->
        <h4 class="mb-3">Statistics</h4>
        <ul>
            <li>Total Yield: {{ farm.get_total_farm_yield|default:"0" }} tons</li>
            <li>Crops Count: {{ farm.get_crops_count|default:"0" }}</li>
            <li>Average Yield per Dunum: {{ farm.get_average_yield_per_dunum|default:"0" }}</li>
        </ul>


        <hr>

        <!-- Crops Overview -->
        <h4 class="mb-3">Crops Overview</h4>
        {% if crops %}
        <ul class="list-group mb-3">
            {% for crop in crops %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ crop.name }}</strong><br>
                    Area: {{ crop.area }} dunum<br>
                    Share of farm: {{ crop.percentage }}%
                </div>
            </li>
            {% endfor %}
        </ul>

        <p><strong>Total Crop Area:</strong> {{ total_crop_area }} dunum</p>

        {% if area_exceeded %}
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i> Total crop area exceeds farm capacity ({{
            farm.total_area }} dunum).
        </div>
        {% else %}
        <div class="alert alert-light p-1 px-2">
            <i class="bi bi-check-circle-fill text-success me-1"></i> Crop area is within farm capacity.
        </div>
        {% endif %}

        {% else %}
        <div class="alert alert-info">No crops planted yet for this farm.</div>
        {% endif %}

        <hr>

        {% if latest_activities %}
        <div class="card mb-4">
            <div
                class="card-header bg-secondary d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                <h5 class="mb-0 text-white">
                    <i class="bi bi-file-earmark-text text-muted fs-4"></i> Latest Activities
                </h5>

                <a href="{% url 'rootsPlusApp:farm_activities' farm.id %}"
                    class="btn btn-outline-warning btn-sm ms-auto">
                    <i class="bi bi-list-task me-1"></i> View All Activities
                </a>
            </div>
            <ul class="list-group list-group-flush">
                {% for activity in latest_activities %}
                <li class="list-group-item">
                    <strong>{{ activity.get_activity_type_display }}</strong>
                    on <span class="text-primary">{{ activity.crop.crop_name }} </span>
                    - at {{ activity.date|date:"Y-m-d H:i" }}<br>
                    {% if activity.notes %}
                    <small class="text-muted mt-2"><span class="text-danger fw-bold ">Notes:</span>
                        {{activity.notes}}</small>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% else %}
        <div class="alert alert-warning">No activities recorded yet.</div>
        {% endif %}

        <hr>

        <!-- Evaluations -->
        <div class="card mb-4">
            <div
                class="card-header bg-secondary d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                <h5 class="mb-0 text-white">
                    <i class="bi bi-card-checklist me-2 text-dark"></i> Latest Evaluations
                </h5>

                <div class="d-flex flex-wrap justify-content-md-end gap-2">
                    <a href="{% url 'rootsPlusApp:evaluations_list' farm.id %}"
                        class="btn btn-outline-warning btn-sm ms-auto">
                        <i class="bi bi-list-task me-1"></i> View All Evaluations
                    </a>

                    {% if role == 'agronomist' and is_managed %}
                    <a href="{% url 'rootsPlusApp:add_evaluation' farm.id %}" class="btn btn-secondary btn-sm ms-auto">
                        <i class="bi bi-plus-circle me-1"></i> Add Evaluation
                    </a>
                    {% endif %}
                </div>
            </div>



            {% if evaluations %}
            <ul class="list-group list-group-flush">
                {% for eval in evaluations %}
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>Season:</strong> {{ eval.season|default:"N/A" }}<br>
                            <strong>Score:</strong> {{ eval.overall_score|default:"-" }}<br>
                            <strong>Recommendations:</strong>
                            <ul class="mb-0">
                                {% for line in eval.recommendations.splitlines %}
                                {% if line %}
                                <li> {{ line }}</li>
                                {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                        <div>
                            <a href="{% url 'rootsPlusApp:evaluation_detail' eval.id %}"
                                class="btn btn-sm btn-outline-dark text-danger">
                                View
                            </a>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="card-body">
                <div class="alert alert-info mb-0">
                    No evaluations recorded for this farm yet.
                </div>
            </div>
            {% endif %}
        </div>

        <hr>

        <div class="card mb-4">
            <div
                class="card-header bg-secondary d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                <h5 class="mb-0 text-white">
                    <i class="bi bi-card-list me-2 text-dark"></i> Latest Reports
                </h5>

                <div class="d-flex flex-wrap justify-content-md-end align-items-end gap-2">
                    <a href="{% url 'rootsPlusApp:reports_list' farm.id %}" class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-file-earmark-text me-1"></i> View All Reports
                    </a>

                    {% if role == 'agronomist' and is_managed %}
                    <a href="{% url 'rootsPlusApp:add_report' farm.id %}" class="btn btn-secondary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i> Add Report
                    </a>
                    {% endif %}
                </div>

            </div>


            {% if latest_reports %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0 text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Season</th>
                            <th>Score</th>
                            <th>Generated At</th>
                            <th>Summary</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in latest_reports %}
                        <tr>
                            <td>{{ report.season|default:"N/A" }}</td>
                            <td>{{ report.overall_score|default:"-" }}</td>
                            <td>{{ report.generated_at|date:"Y-m-d H:i" }}</td>
                            <td>{{ report.summary|truncatewords:10 }}</td>
                            <td>
                                <a href="{% url 'rootsPlusApp:report_detail' report.farm.id report.id %}"
                                    class="btn btn-sm btn-outline-secondary">
                                    View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="card-body">
                <div class="alert alert-light mb-0">
                    No reports have been generated for this farm yet.
                </div>
            </div>
            {% endif %}
        </div>

        <a href="{% url 'rootsPlusApp:dashboard' %}" class="btn btn-secondary mt-3 d-none d-md-inline">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>



    </div>


    <!-- Right Side -->
    <div class="rightSide col-10 mx-auto col-md-3">

        <div class="controlsLargeScreen  d-none d-md-block">
            
            {% if role in 'user farmer' %}
            <div class="mb-3 d-flex align-items-center">
                <form method="post" action="{% url 'rootsPlusApp:delete_farm' farm.id %}"
                    onsubmit="return confirm('⚠️ Are you sure you want to delete this farm? This action cannot be undone.');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger me-2">
                        <i class="bi bi-trash me-1"></i> Delete Farm
                    </button>
                </form>
                <a href="{% url 'rootsPlusApp:edit_farm_crops' farm.id %}" class="btn btn-outline-primary ">
                    <i class="bi bi-pencil-square me-1"></i> Edit Crops
                </a>
            </div>
            {% endif %}

            
            {% if role == 'agronomist' %}
            <div class="mb-3">
                {% if is_managed %}
                <!-- Unmanage Farm -->
                <form id="unmanage-farm-form" method="post" action="{% url 'rootsPlusApp:unmanage_farm' farm.id %}"
                    class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger"
                        onclick="return confirm('⚠️ Are you sure you want to unmanage this farm?');">
                        <i class="bi bi-x-circle me-1"></i> Unmanage Farm
                    </button>
                </form>
                {% else %}
                <!-- Manage Farm -->
                <form method="post" action="{% url 'rootsPlusApp:manage_farm' farm.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-1"></i> Manage Farm
                    </button>
                </form>
                {% endif %}
            </div>
            {% endif %}
            <div class="d-flex align-items-center gap-2">
                {% if role == 'agronomist' and is_managed %}
                <a href="{% url 'rootsPlusApp:add_activity' farm.id %}" class="btn btn-sm btn-success mb-3">
                    <i class="bi bi-plus-circle me-1"></i> Add New Activity
                </a>
                {% endif %}

                <a href="{% url 'rootsPlusApp:farm_activities' farm.id %}" class="btn btn-warning btn-sm mb-3">
                    <i class="bi bi-list-task me-1"></i> View All Activities
                </a>
            </div>
        </div>




        <hr>
        <h4>Farm Analysis</h4>

        {% if not analysis and is_managed %}
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-success text-white">Add Farm Analysis</div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Soil Type</label>
                        <input type="text" name="soil_type" class="form-control" reqiured>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Soil Salinity (dS/m)</label>
                        <input type="number" step="0.01" name="soil_salinity" class="form-control" reqiured>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Soil pH</label>
                        <input type="number" step="0.01" name="soil_ph" class="form-control" reqiured>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Water Salinity (dS/m)</label>
                        <input type="number" step="0.01" name="water_salinity" class="form-control" reqiured>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Analysis Date</label>
                        <input type="date" name="analysis_date" class="form-control" reqiured>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Save Analysis</button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-primary text-white">Analysis Data</div>
            <div class="card-body">
                <p><strong>Soil Type:</strong> {{ analysis.soil_type|default:"N/A" }}</p>
                <p><strong>Soil Salinity:</strong> {{ analysis.soil_salinity|default:"N/A" }} dS/m</p>
                <p><strong>Soil pH:</strong> {{ analysis.soil_ph|default:"N/A" }}</p>
                <p><strong>Water Salinity:</strong> {{ analysis.water_salinity|default:"N/A" }} dS/m</p>
                <p><strong>Analysis Date:</strong> {{ analysis.analysis_date|default:"N/A" }}</p>
            </div>
        </div>
        {% endif %}

        <hr>
        <div class="d-flex flex-column align-items-center gap-2">
            <h4>Crops Distribution</h4>
            <canvas id="cropPieChart" width="400" height="400"></canvas>
            <hr class="w-100">
            <canvas id="cropEfficiencyChart" height="320"></canvas>
            <hr class="w-100">
        </div>

    </div>
    <a href="{% url 'rootsPlusApp:dashboard' %}" class="btn btn-secondary mt-3 btn-sm d-inline d-md-none ms-auto">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>

</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('cropPieChart').getContext('2d');

        const cropLabels = JSON.parse('{{ crop_labels|escapejs }}');
        const cropAreas = JSON.parse('{{ crop_areas|escapejs }}');

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: cropLabels,
                datasets: [{
                    data: cropAreas,
                    backgroundColor: [
                        '#3E7D60', 
                        '#41CAB3', 
                        '#74ACB2', 
                        '#19183B', 
                        '#708993', 
                        '#A1C2BD', 
                        '#E7F2EF'
                    ],
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} dunum (${percentage}%)`;
                            }
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 12
                        },
                        formatter: function (value, context) {
                            const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${percentage}%`;
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

    });

</script>
<script>
    const cropEfficiency = JSON.parse('{{ crop_efficiency_json|escapejs }}');

    const labels = cropEfficiency.map(item => item.name);
    const yields = cropEfficiency.map(item => item.yield);
    const activities = cropEfficiency.map(item => item.activities);
    const maxValue = Math.max(...yields.concat(activities));
    const suggestedMax = Math.ceil(maxValue * 1.2); 

    new Chart(document.getElementById('cropEfficiencyChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Yield (tons/dunum)',
                    data: yields,
                    backgroundColor: '#A1887F'
                },
                {
                    label: 'Activities Count',
                    data: activities,
                    backgroundColor: '#00BCD4'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: suggestedMax,
                    title: { display: true, text: 'Value' }
                }
            }
        }
    });
</script>



<script>
    async function loadFarmWeather(farmId) {
        const container = document.getElementById("farmWeatherContainer");
        if (!container) return;

        container.innerHTML = "";

        try {
            const response = await fetch(`/content/farm_weather/${farmId}/`, { cache: "no-store" });
            const item = await response.json();

            const card = `
        <div class="card shadow border-0 rounded-3 bg-light">
          <div class="card-body d-flex justify-content-center align-items-center gap-4">
            <p class="fw-semibold text-primary ">
              <i class="bi bi-leaf me-1 text-success "></i> ${item.location}
            </p>
            <p class="fw-bold text-dark ">
              <i class="bi bi-thermometer-half text-warning me-1 "></i> ${item.temp} °C
            </p>
            <p class="text-dark ">
              <i class="bi bi-cloud-sun-fill text-info me-1 "></i> ${item.desc}
            </p>
            <p class="text-dark  ">
            <i class="bi bi-clock text-dark fw-bold"></i> ${item.time}
            </p>
          </div>
        </div>
      `;
            container.innerHTML = card;
        } catch (error) {
            container.innerHTML = "<p class='text-danger'>Unable to fetch weather</p>";
        }
    }

    // استدعِ الدالة مع ID المزرعة
    loadFarmWeather({{ farm.id }});
</script>
{% endblock %}